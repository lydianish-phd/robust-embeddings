#!/bin/bash

#SBATCH --job-name=validate      # Job name
#SBATCH --ntasks=1               # total number of tasks across all nodes
#SBATCH --cpus-per-task=16       # cpu-cores per task (>1 if multi-threaded tasks)
#SBATCH --hint=multithread       # we get physical cores not logical
#SBATCH --time=24:00:00               # Time limit hrs:min:sec
#SBATCH --output=/scratch/lnishimw/logs/robust-embeddings/laser/validate/validate_%j.log # Standard output and error log
#SBATCH --array=1-4

set -e 

echo "### Running $SLURM_JOB_NAME $SLURM_ARRAY_TASK_ID ###"

source $HOME/.bashrc
source $HOME/.bash_profile
source activate laser_env

# to be able to use fairseq files
FAIRSEQ_PATH=$SCRATCH/fairseq/
export PYTHONPATH=$PYTHONPATH:$FAIRSEQ_PATH

# to be able to use LASER files
LASER_PATH=$LASER/source/
export PYTHONPATH=$PYTHONPATH:$LASER_PATH

MODEL_NAME[0]=laser
MODEL_PATH[0]=$LASER/models/laser2.pt
VOCAB_FILE[0]=$LASER/models/laser2.cvocab

MODEL_NAME[1]=roberta-student
MODEL_PATH[1]=$EXPERIMENTS/robust-embeddings/laser/experiment_024_jz/checkpoints/${MODEL_NAME[1]}
VOCAB_FILE[1]=$MODELS/checkpoints/roberta-base/roberta.cvocab

MODEL_NAME[2]=roberta-student-init
MODEL_PATH[2]=$EXPERIMENTS/robust-embeddings/laser/experiment_024_jz/checkpoints/${MODEL_NAME[2]}
VOCAB_FILE[2]=$MODELS/checkpoints/roberta-base/roberta.cvocab

MODEL_NAME[3]=character-roberta-student
MODEL_PATH[3]=$EXPERIMENTS/robust-embeddings/laser/experiment_024_jz/checkpoints/${MODEL_NAME[3]}
VOCAB_FILE[3]=$DATASETS/oscar/mini/4M/bin/charobertaugc-charobertastd/dict.charobertaugc.txt

MODEL_NAME[4]=character-roberta-student-init
MODEL_PATH[4]=$EXPERIMENTS/robust-embeddings/laser/experiment_024_jz/checkpoints/${MODEL_NAME[4]}
VOCAB_FILE[4]=$DATASETS/oscar/mini/4M/bin/charobertaugc-charobertastd/dict.charobertaugc.txt

VALIDATION_SEED=110
INPUT_EXPERIMENT_DIR=$EXPERIMENTS/robust-embeddings/laser/experiment_025_lrec
PREFIX=flores200/$VALIDATION_SEED/dev
OUTPUT_EXPERIMENT_DIR=$EXPERIMENTS/robust-embeddings/laser/experiment_025_jz

python $HOME/robust-embeddings/src/laser/validate.py \
    --input-tok-dir $INPUT_EXPERIMENT_DIR/tok \
    --teacher-model ${MODEL_NAME[0]} \
    --teacher-model-path ${MODEL_PATH[0]} \
    --teacher-vocab ${VOCAB_FILE[0]} \
    --student-model ${MODEL_NAME[$SLURM_ARRAY_TASK_ID]} \
    --student-model-dir ${MODEL_PATH[$SLURM_ARRAY_TASK_ID]} \
    --student-vocab ${VOCAB_FILE[$SLURM_ARRAY_TASK_ID]} \
    --ugc-file $PREFIX/cleaned.eng_Latn_ugc.dev \
    --std-file $PREFIX/cleaned.eng_Latn.dev \
    --output-dir $OUTPUT_EXPERIMENT_DIR \

echo "Done..."